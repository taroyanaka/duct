<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vue_3_starter</title>
    <link rel="stylesheet" href="./lib/reset.css">
<script src="./lib/vue@3.2.36.global.prod.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.36/vue.cjs.js"></script> -->
</head>
<body class="app">
    <!-- this.nameのinput:text -->
    <input type="text" v-model="name" placeholder="name">
    <!-- this.passwordのinput -->
    <input type="password" v-model="password" placeholder="password">
    <!-- this.linkのinput -->
    <input type="url" v-model="link" placeholder="link">
    <!-- fetch_insert_linkを実行するボタン -->
    <button @click="fetch_insert_link">fetch_insert_link</button>


<!-- web_dataをレンダリングする -->
<template v-for="(DATA_VAL, DATA_IDX) in web_data">
    <!-- 以下のプロパティを全てレンダリングする -->
    <!--  { "id": 3, "link": "https://yanaka.dev/", "created_at": "2023-06-07T09:16:24.846Z", "updated_at": "2023-06-07T09:16:24.846Z", "user_id": 2, "username": "user1", "like_count": 0, "tags": [], "comments_and_replies": [] } -->
    <div>{{ DATA_VAL.id }}</div>
    <!-- DATA_VAL.idからlinkを削除する -->
    <button @click="fetch_delete_link(DATA_VAL.id)">fetch_delete_link</button>
    <div>{{ DATA_VAL.link }}</div>
    <div>{{ DATA_VAL.created_at }}</div>
    <div>{{ DATA_VAL.updated_at }}</div>
    <div>{{ DATA_VAL.user_id }}</div>
    <div>{{ DATA_VAL.username }}</div>
    <!-- like_count, tags, comments_and_replies に関しては空か空の配列の場合はレンダリングしない -->
    <div v-if="DATA_VAL.like_count">{{ DATA_VAL.like_count }}</div>
    <!-- <div v-if="DATA_VAL.tags.length">{{ DATA_VAL.tags }}</div> -->
    <div>{{ DATA_VAL.tags }}</div>
    <!-- fetch_insert_tagでタグを挿入するためのinput:text -->
    <input type="text" v-model="tag" placeholder="tag" maxlength="7" minlength="1" @input="tag_check($event.target.value)">
    <!-- fetch_insert_tagを実行するボタン -->
    <button @click="fetch_insert_tag(DATA_VAL.id)">fetch_insert_tag</button>
        <!-- tags配列をレンダリングする -->
        <template v-for="(DATA_VAL_2, DATA_IDX_2) in DATA_VAL.tags">
            <!-- 以下のプロパティを全てレンダリングする -->
            <!-- { "id": 1, "tag": "tag1" } -->
            <div>{{ DATA_VAL_2.id }}</div>
            <div>{{ DATA_VAL_2.tag }}</div>
            <!-- DATA_VAL_2.idからtagを削除する。パラメーターはLINK_ID, TAG_ID -->
            <button @click="fetch_delete_tag(DATA_VAL.id, DATA_VAL_2.id)">fetch_delete_tag</button>
        </template>

    <div v-if="DATA_VAL.comments_and_replies.length">{{ DATA_VAL.comments_and_replies }}</div>
</template>




    <h1>duct</h1>
    <h2> :ja ductはlink共有とlinkへのコメントをするwebサービスです </h2>
    <h2> :en duct is a web service that allows you to share links and comment on them. </h2>

<!-- <button @click="fn_0">fn_0</button>
<template v-for="(DATA_VAL, DATA_IDX) in data_1">
<div>{{ DATA_VAL }}</div>
</template>
<textarea name="" id="" cols="30" rows="10" v-model="data_0"></textarea> -->
</body>
<script>
const app = Vue.createApp({
data() {
    return {
name: 'user1',
password: 'user_pass1',
web_data: {},
link: 'https://yanaka.dev/',
tag: 'tag1',
    }},
watch: {
//    any: {
//      handler() {
//      },
//      deep: true
//    },
},
beforeMounte(){
},
mounted() {
    // this.fetch_hello_world();
    this.fetch_read_all();
},
beforeUpdate() {
},
updated() {
},
methods: {
async fetch_hello_world(){
    const res = await fetch(
        // this.get_domain_and_port_of_test_mode_or_product_mode()
        'http://localhost:8000/'
    );
    const data = await res.json(); console.log(data);
},


// // linkテーブル以下のデータを取得する
// app.get('/read_all', (req, res) => {
//   try {
//     const pre_result = db.prepare(`
//         SELECT
//         link.id AS id, link.title AS title, link.link AS link, link.created_at AS created_at, link.updated_at AS updated_at,
//         users.id AS user_id, users.username AS username,
//         (SELECT COUNT(*) FROM likes WHERE likes.link_id = link.id) AS like_count
//         FROM link
//         LEFT JOIN users ON link.user_id = users.id
//         LEFT JOIN likes ON link.id = likes.link_id
//         ORDER BY link.id DESC
//     `).all();

//     const result = pre_result.map(parent => {
//       const tags = db.prepare(`
//         SELECT
//         tags.id AS id, tags.tag AS tag
//         FROM tags
//         LEFT JOIN link_tags ON tags.id = link_tags.tag_id
//         WHERE link_tags.link_id = ?
//       `).all(parent.id);

//       const comments = db.prepare(`
//         SELECT
//         comments.id AS id, comments.comment AS comment, comments.created_at AS created_at, comments.updated_at AS updated_at,
//         users.id AS user_id, users.username AS username
//         FROM comments
//         LEFT JOIN links ON comments.link_id = links.id
//         LEFT JOIN users ON comments.user_id = users.id
//         WHERE links.id = ?
//       `).all(parent.id);

//         const comments_and_replies = comments.map(comment => {
//             const comment_replies = db.prepare(`
//             SELECT
//             comment_replies.id AS id, comment_replies.comment AS comment, comment_replies.created_at AS created_at, comment_replies.updated_at AS updated_at,
//             users.id AS user_id, users.username AS username
//             FROM comment_replies
//             LEFT JOIN comments ON comment_replies.comment_id = comments.id
//             LEFT JOIN users ON comment_replies.user_id = users.id
//             WHERE comments.id = ?
//             `).all(comment.id);
//             return {
//                 ...comment,
//                 comment_replies,
//             }
//         });

//       return {
//         ...parent,
//         tags,
//         comments_and_replies,
//       };
//     });

//     res.json(result);
//   } catch (error) {
//     console.log(error);
//     error_response(res, '原因不明のエラー' + error);
//   }
// });

// read_allをfetchする関数
async fetch_read_all(){
    const res = await fetch('http://localhost:8000' + '/read_all', {method: 'GET', headers: {'Content-Type': 'application/json',},
        // body: JSON.stringify({
        //     name: this.name,
        //     password: this.password
        // }),
    });
    this.web_data = await res.json(); console.log(this.web_data);
},

// // linkにデータをレコード挿入するエンドポイント
// app.post('/insert_link', (req, res) => {
//     try {
//         const user = get_user_with_permission(req);
//         user || user.writable ? null : error_response(res, '権限がありません');
//         const result = db.prepare(`
//         INSERT INTO link (user_id, link, created_at, updated_at) VALUES (?, ?, ?, ?, ?)
//         `).run(user.user_id, req.body.link, now(), now());
//         res.json(result);
//     } catch (error) {
//         console.log(error);
//         error_response(res, '原因不明のエラー' + error);
//     }
// });
async fetch_insert_link(){
    const res = await fetch('http://localhost:8000' + '/insert_link', {method: 'POST',headers: {'Content-Type': 'application/json',},
        body: JSON.stringify({
            name: this.name,
            password: this.password,
            link: this.link
        }),
    });
    const data = await res.json(); console.log(data);
},

// // linkのデータを削除する
// app.post('/delete_link', (req, res) => {
//     try {
//         const user = get_user_with_permission(req);
//         user || user.deletable ? null : error_response(res, '権限がありません');
//         const result = db.prepare(`
//         DELETE FROM link WHERE id = ? AND user_id = ?
//         `).run(req.body.id, user.user_id);
//         res.json(result);
//     } catch (error) {
//         console.log(error);
//         error_response(res, '原因不明のエラー' + error);
//     }
// });
async fetch_delete_link(LINK_ID){
    const res = await fetch('http://localhost:8000' + '/delete_link', {method: 'POST',headers: {'Content-Type': 'application/json',},
        body: JSON.stringify({
            name: this.name,
            password: this.password,
            id: LINK_ID
        }),
    });
    const data = await res.json(); console.log(data);
},

// // tagにデータをレコード挿入するエンドポイント
// // 既に存在する場合は、既存のタグを返す
// // 存在しない場合は、新規にタグを作成して返す
// // 既存のタグを返す場合は、links_tagsにレコードを挿入する
// // 新規にタグを作成して返す場合は、tagsにレコードを挿入して、links_tagsにレコードを挿入する
// app.post('/insert_tag', (req, res) => {
//     try {
//         // tagは記号を含む場合はエラー、空白を含む場合はエラー、7文字以上はエラー、既に存在する場合はエラー、SQLの予約語を含む場合はエラー
//         const error_check = (tag) => {
//             const reserved_words = ['SELECT', 'FROM', 'WHERE', 'INSERT', 'DELETE', 'UPDATE', 'DROP', 'ALTER', 'CREATE', 'TABLE', 'INTO', 'VALUES', 'AND', 'OR', 'NOT', 'NULL', 'TRUE', 'FALSE'];
//             if (tag.match(/[!-/:-@[-`{-~]/g)) {
//                 return false;
//             } else if (tag.match(/\s/g)) {
//                 return false;
//             } else if (tag.length > 7) {
//                 return false;
//             } else if (reserved_words.includes(tag)) {
//                 return false;
//             } else {
//                 return true;
//             }
//         }
//         error_check(req.body.tag) ? null : error_response(res,
//             `tagは、
//             記号を含む場合はエラー、
//             空白を含む場合はエラー、
//             7文字以上はエラー、
//             既に存在する場合はエラー、
//             SQLの予約語を含む場合はエラー`);
//         const user = get_user_with_permission(req);
//         user || user.writable ? null : error_response(res, '権限がありません');
//         const tag = db.prepare(`
//         SELECT id, tag FROM tags WHERE tag = ?
//         `).get(req.body.tag);
//         if (tag) {
//             const result = db.prepare(`
//             INSERT INTO links_tags (link_id, tag_id) VALUES (?, ?)
//             `).run(req.body.link_id, tag.id);
//             res.json(tag);
//         } else {
//             const result = db.prepare(`
//             INSERT INTO tags (tag) VALUES (?)
//             `).run(req.body.tag);
//             const tag = db.prepare(`
//             SELECT id, tag FROM tags WHERE tag = ?
//             `).get(req.body.tag);
//             const result2 = db.prepare(`
//             INSERT INTO links_tags (link_id, tag_id) VALUES (?, ?)
//             `).run(req.body.link_id, tag.id);
//             res.json(tag);
//         }
//     } catch (error) {
//         console.log(error);
//         error_response(res, '原因不明のエラー' + error);
//     }
// });
async fetch_insert_tag(LINK_ID, TAG){
    const res = await fetch('http://localhost:8000' + '/insert_tag', {method: 'POST',headers: {'Content-Type': 'application/json',},
        body: JSON.stringify({
            name: this.name,
            password: this.password,
            link_id: LINK_ID,
            tag: this.tag
        }),
    });
    const data = await res.json(); console.log(data);
},
tag_check(TAG){
        // tagは記号を含む場合はエラー、空白を含む場合はエラー、7文字以上はエラー、既に存在する場合はエラー、SQLの予約語の場合はエラー
        const error_check = (tag) => {
            const reserved_words = ['SELECT', 'FROM', 'WHERE', 'INSERT', 'DELETE', 'UPDATE', 'DROP', 'ALTER', 'CREATE', 'TABLE', 'INTO', 'VALUES', 'AND', 'OR', 'NOT', 'NULL', 'TRUE', 'FALSE'];
            if (tag === undefined) {
                return {res: 'tagが空です', status: false};
            } else if (tag.match(/[!-/:-@[-`{-~]/g)) {
                return {res: '記号を含む場合はエラー', status: false};
            } else if (tag.match(/\s/g)) {
                return {res: '空白を含む場合はエラー', status: false};
            } else if (tag.length > 7) {
                return {res: '7文字以上はエラー', status: false};
            } else if (reserved_words.includes(tag)) {
                return {res: 'SQLの予約語を含む場合はエラー', status: false};
            } else {
                return {res: 'OK', status: true};
            }
        }
        // console.log(error_check(TAG));
        return error_check(TAG);
},

// // tagのデータを削除する
// // 他に紐づくlinkが有る場合は、links_tagsのレコードを削除する
// // 他に紐づくlinkが無い場合は、tagsのレコードとlinks_tagsのレコードを削除する
// app.post('/delete_tag', (req, res) => {
//     try {
//         const user = get_user_with_permission(req);
//         user || user.deletable ? null : error_response(res, '権限がありません');
//         const result = db.prepare(`
//         SELECT COUNT(*) AS count FROM links_tags WHERE tag_id = ?
//         `).get(req.body.id);
//         if (result.count > 1) {
//             const result2 = db.prepare(`
//             DELETE FROM links_tags WHERE tag_id = ? AND link_id = ?
//             `).run(req.body.id, req.body.link_id);
//             res.json(result2);
//         } else {
//             const result2 = db.prepare(`
//             DELETE FROM links_tags WHERE tag_id = ?
//             `).run(req.body.id);
//             const result3 = db.prepare(`
//             DELETE FROM tags WHERE id = ?
//             `).run(req.body.id);
//             res.json(result3);
//         }
//     } catch (error) {
//         console.log(error);
//         error_response(res, '原因不明のエラー' + error);
//     }
// });
async fetch_delete_tag(LINK_ID, TAG_ID){
    const res = await fetch('http://localhost:8000' + '/delete_tag', {method: 'POST',headers: {'Content-Type': 'application/json',},
        body: JSON.stringify({
            name: this.name,
            password: this.password,
            link_id: LINK_ID,
            id: TAG_ID
        }),
    });
    const data = await res.json(); console.log(data);
},





},
}).mount('.app');
</script>
</html>